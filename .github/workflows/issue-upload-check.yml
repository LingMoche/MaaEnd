name: Issue Upload Check

on:
  issues:
    types: [opened, edited]

jobs:
  check-upload-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check for upload keywords
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || '';
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸Šä¼ ç›¸å…³çš„å…³é”®è¯
            const uploadFailedPattern = /Failed to upload/i;
            const uploadingPattern = /Uploading/i;
            
            const hasUploadFailed = uploadFailedPattern.test(issueBody);
            const hasUploading = uploadingPattern.test(issueBody);
            
            if (hasUploadFailed || hasUploading) {
              // æ£€æŸ¥æ˜¯å¦å·²ç»å›å¤è¿‡
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              
              const botAlreadyCommented = comments.data.some(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('æˆ‘ä»¬æ£€æµ‹åˆ°ä½ çš„ issue ä¸­åŒ…å«ä¸Šä¼ ç›¸å…³çš„ä¿¡æ¯')
              );
              
              if (!botAlreadyCommented) {
                let replyMessage = 'ğŸ‘‹ ä½ å¥½ï¼æˆ‘ä»¬æ£€æµ‹åˆ°ä½ çš„ issue ä¸­åŒ…å«ä¸Šä¼ ç›¸å…³çš„ä¿¡æ¯ã€‚\n\n';
                
                if (hasUploadFailed) {
                  replyMessage += 'âš ï¸ **æ£€æµ‹åˆ°ä¸Šä¼ å¤±è´¥**\n';
                  replyMessage += 'å¦‚æœä½ åœ¨æäº¤ issue æ—¶é‡åˆ°äº†æ–‡ä»¶ä¸Šä¼ å¤±è´¥çš„é—®é¢˜ï¼Œè¯·ï¼š\n';
                  replyMessage += '1. ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸\n';
                  replyMessage += '2. æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡ GitHub é™åˆ¶ï¼ˆå•ä¸ªæ–‡ä»¶ 25MBï¼Œæ€»å…± 100MBï¼‰\n';
                  replyMessage += '3. å°è¯•é‡æ–°ä¸Šä¼ æ–‡ä»¶\n';
                  replyMessage += '4. å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå¯ä»¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°å…¶ä»–å¹³å°ï¼ˆå¦‚ QQ ç¾¤æ–‡ä»¶ï¼‰å¹¶åœ¨ issue ä¸­æä¾›å¤‡æ³¨å…·ä½“æ–‡ä»¶å\n\n';
                }
                
                if (hasUploading) {
                  replyMessage += 'â³ **æ£€æµ‹åˆ°ä¸Šä¼ è¿›è¡Œä¸­**\n';
                  replyMessage += 'çœ‹èµ·æ¥ä½ å¯èƒ½åœ¨æ–‡ä»¶è¿˜åœ¨ä¸Šä¼ æ—¶å°±æäº¤äº† issueã€‚ä¸ºäº†ç¡®ä¿æˆ‘ä»¬èƒ½çœ‹åˆ°å®Œæ•´çš„ä¿¡æ¯ï¼Œè¯·ï¼š\n';
                  replyMessage += '1. ç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆåå†æäº¤\n';
                  replyMessage += '2. å¦‚æœå·²ç»æäº¤ï¼Œå¯ä»¥ç¼–è¾‘ issue é‡æ–°ä¸Šä¼ æ–‡ä»¶\n';
                  replyMessage += '3. æˆ–è€…å°†æ–‡ä»¶ä¸Šä¼ åˆ°å…¶ä»–å¹³å°ï¼ˆå¦‚ QQ ç¾¤æ–‡ä»¶ï¼‰å¹¶åœ¨ issue ä¸­æä¾›å¤‡æ³¨å…·ä½“æ–‡ä»¶å\n\n';
                }
                
                replyMessage += 'æ„Ÿè°¢ä½ çš„åé¦ˆï¼ğŸ™';
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: replyMessage
                });
                
                console.log('å·²è‡ªåŠ¨å›å¤ issue #' + issue.number);
              } else {
                console.log('Bot å·²ç»å›å¤è¿‡æ­¤ issueï¼Œè·³è¿‡é‡å¤å›å¤');
              }
            } else {
              console.log('æœªæ£€æµ‹åˆ°ä¸Šä¼ ç›¸å…³å…³é”®è¯');
            }
